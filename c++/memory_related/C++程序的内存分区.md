# C++的内存分区

| 分区名 | Description |
| ------ | ----------- |
| 栈区（Stack Segment）  | 函数内部局部变量的存储单元都在栈上创建，栈内存分配内置于处理器的指令集中，效率很高，但分配的内存容量有限 |
| 未使用内存（Unused Memory） |  |
| 堆区（Heap Segment）    | 由new分配的内存块，编译器不管它们的释放，他们的释放由应用程序负责，如果没有delete，程序结束后，操作系统会自动回收 |
| 全局数据区（Global Data Segment） | 全局变量和静态变量的存储区，主要存放全局变量，全局static变量，局部static变量和常量 |
| 常量区（Constant Segment）| 存放的是常量字符串，不允许修改 |
| 代码区（Code Segment）|  程序的二进制代码，存放所有的函数，无论是全局函数还是成员函数 |

# 堆和栈的区别
|比较方面 | 堆  | 栈 |
|------:|---: | ---: |
|申请方式 | 由用户申请和释放 | 栈由系统自动分配 |
| 申请大小| 堆由高地址扩展，是不连续的内存区域，大小可以灵活调整 | 栈顶和栈底是预设好的，栈是向栈底扩展，大小固定，ulimit -a查看，ulimit -s修改 |
| 申请效率 | 速度慢，有碎片 | 速度快，没有碎片 |
| 分配方式 | 都是动态分配 | 栈有静态分配和动态分配，静态分配由编译器完成，动态分配由alloca函数分配，但由编译器释放 |
| 内存管理机制|系统有一个空闲内存地址的链表，当OS收到程序申请时，遍历该链表，寻找第一个空间大于申请空间的堆节点，将该节点分配给空间分配给程序，并从空闲链表中删除 | 栈的剩余空间大于所申请空间，系统为程序提供内存，否则报异常提示栈溢出  |
注：栈空间默认4M，堆区一般1-4G

# new/delete 与 malloc/free
| new/delete |  malloc/free |
| --: | --: |
|  C++运算符 | C/C++语言标准库函数 |
| new自动计算要分配的空间大小 | malloc要手工计算 |
| 返回的是具体类型指针 | 返回的是void类型指针（必须进行类型转换） |
| new是类型安全的 | malloc不是 |
| new支持重载 | 支持覆盖 |
联系：new调用标准库函数operator new分配足够空间并调用相关对象的构造函数，delete对指针所指对象运行适当的析构函数，然后调用标准库函数operator delete释放该对象的内存。new封装了malloc，直接free不会报错，但只是释放内存，不会析构对象。